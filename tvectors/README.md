# SLH-DSA Test Vectors

This folder contains some things that are used to create test vectors
using the an "as close as possible" implementation of SPHINCS+, patched
to be SLH-DSA compatible.

The test vectors are generated by using the SPHINCS+ reference
implementation

    https://github.com/sphincs/sphincsplus

However, this implementation is unfortuately *not* compatible with
FIPS.205. See page 1--2 in FIPS.205 for a general description. It is
also described below.

## On differences between FIPS.205 and SPHINCS+

There is a difference in how the bits are ordered when extracting a
sequence of bits (that is used to derive indices that we need in
`fors_sign`, for example).

FIPS.205 orders the bits from higher to lower order, so that the bit
sequence

    b₀, b₁, b₂, ..., bₙ

is represented as bytes such that b₀ is the most significant bit of the
first byte, and b₇ is the least significant bit of the last byte. This
means that the first byte has value

    b₀ 2⁷ + b₁ 2⁶ + ... + b₇,

the second byte has value

    b₈ 2⁷ + b₉ 2⁶ + ... + b₁₅,

and so on.

In comparison, the SPHINCS+ specification (and reference implementation)
considers the least significant bit in each byte to be the first. This
means that the bit sequence

    b₀, b₁, b₂, ..., bₙ

is representated as bytes in such a way that the first byte has value

    b₇ 2⁷ + b₆ 2⁶ + ... + b₀

and the second byte has value

    b₁₅ 2⁷ + b₁₄ 2⁶ + ... + b₈.

Assuming that there is no other suble differences in this, I've done a
quick hack to get some test vectors to compare with. In `fors.c` we
replace the code block

    static void message_to_indices(uint32_t *indices, const unsigned char *m)
    {
        unsigned int i, j;
        unsigned int offset = 0;
    
        for (i = 0; i < SPX_FORS_TREES; i++) {
            indices[i] = 0;
            for (j = 0; j < SPX_FORS_HEIGHT; j++) {
                indices[i] ^= ((m[offset >> 3] >> (offset & 0x7)) & 1u) << j;
                offset++;
            }
        }
    }

with the code block

    static void message_to_indices(uint32_t *indices, const unsigned char *m)
    {
        unsigned int i, j;
        unsigned int offset = 0;
    
        for (i = 0; i < SPX_FORS_TREES; i++) {
            indices[i] = 0;
            for (j = 0; j < SPX_FORS_HEIGHT; j++) {
                indices[i] ^= ((m[offset >> 3] >> (7-(offset & 0x7))) & 1u) << (SPX_FORS_HEIGHT-1-j);
                offset++;
            }
        }
    }

So, suddenly my this _independent_ reference implementation is no longer
independent, because I just had to put my hacky fingers in it.

## Build instructions

Clone the sphincsplus repo and apply the patch:

```console
$ git clone https://github.com/sphincs/sphincsplus.git
$ cd sphincsplus
$ git checkout 035b39429d96ca554402b78f296f0de181674abd
$ cd ref/
$ patch -R -p1 < ../../sphincsplus_ref.patch
```

Compile the test vector generator:

```console
$ sphincs/src
$ make
```

## Example usage instructions

Generate a test vector JSON file for parameter set
`SLH-DSA-SHAKE-128s`:

```console
$ ./build/shake_128s_gen
```
